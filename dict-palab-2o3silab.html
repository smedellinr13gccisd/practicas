<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dictado Pro - Bosque Esmeralda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, #f0fdf4 0%, #bbf7d0 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
        }
        .input-word {
            font-size: 3.5rem;
            text-align: center;
            border-bottom: 5px solid #059669;
            color: #064e3b;
            background: transparent;
            width: 100%;
            outline: none;
        }
        .firecracker {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 100;
        }
        @keyframes particle {
            0% { transform: translate(0, 0); opacity: 1; }
            100% { transform: translate(var(--tw-x), var(--tw-y)); opacity: 0; }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="main-container" class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-xl space-y-8 relative border-b-8 border-emerald-600">
        
        <!-- Header -->
        <div class="flex justify-between items-center">
            <div class="bg-emerald-600 text-white px-5 py-1.5 rounded-full font-bold text-sm">
                Progreso: <span id="count">1</span> / 500
            </div>
            <div class="flex items-center space-x-2 text-emerald-700 font-bold">
                <span class="w-3 h-3 bg-emerald-500 rounded-full animate-pulse"></span>
                <span>En Línea</span>
            </div>
        </div>

        <!-- Área de Audio -->
        <div class="flex flex-col items-center space-y-6">
            <button id="btn-play" class="bg-emerald-500 hover:bg-emerald-600 text-white w-32 h-32 rounded-full flex items-center justify-center shadow-lg transform transition active:scale-95">
                <div id="icon-play">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                    </svg>
                </div>
                <div id="loading-spinner" class="loader hidden"></div>
            </button>
            <p class="text-emerald-800 font-medium">Pulsa el botón para escuchar</p>
        </div>

        <!-- Área de Input -->
        <div class="space-y-4">
            <input type="text" id="input-word" class="input-word" placeholder="..." autocomplete="off">
            <p class="text-center text-emerald-600 text-sm font-bold">Presiona ENTER para validar</p>
        </div>

        <!-- Botón Siguiente -->
        <button id="btn-next" class="hidden w-full py-4 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold text-xl shadow-md transition-all">
            ¡Correcto! Siguiente palabra →
        </button>
    </div>

    <!-- Mensaje Error / Configuración -->
    <div id="error-msg" class="fixed bottom-4 left-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded hidden">
        <p><b>Error de voz:</b> Asegúrate de tener conexión a internet y una API Key válida.</p>
    </div>

    <script type="module">
        // El apiKey se obtiene del entorno si existe, sino se queda vacío.
        // NOTA: Para que funcione en GitHub Pages, necesitas pegar tu llave aquí:
        const apiKey = ""; 

        const words = ["blusa", "brazo", "clase", "clavo", "crema", "crudo", "dragón", "dril", "fresa", "fruta", "flaco", "flota", "globo", "glaciar", "gratis", "gruta", "pluma", "plato", "primo", "presa", "trigo", "tren", "atleta", "tabla", "libro", "sobre", "cerca", "arco", "alto", "azul", "isla", "antes", "diez", "nariz", "luz", "pobre", "pueblo", "cobre", "brillo", "broche", "clima", "chicle", "claxon", "flecha", "flojo", "flauta", "glicerina", "regla", "siglo", "pleno", "soplo", "planta", "precio", "pronto", "prueba", "truco", "potro", "trapo", "trama", "triunfo", "broma", "bruma", "bravo", "bloque", "blanco", "clavel", "clínica", "cloro", "cráneo", "creer", "cristal", "cromo", "crujir", "drama", "drenar", "droga", "drástico", "frase", "freno", "frotar", "fresco", "fruncir", "flama", "fleco", "fluir", "flúor", "grado", "grano", "grito", "groso", "grupo", "pradera", "predio", "prisa", "proa", "prudente", "traje", "tregua", "trío", "trozo", "trucha"];
        // (Se pueden añadir más palabras hasta las 500)

        let index = 0;
        let currentAudio = null;

        const btnPlay = document.getElementById('btn-play');
        const btnNext = document.getElementById('btn-next');
        const input = document.getElementById('input-word');
        const countDisplay = document.getElementById('count');
        const spinner = document.getElementById('loading-spinner');
        const iconPlay = document.getElementById('icon-play');

        // Helper: Convertir PCM a WAV
        function pcmToWav(pcmData, sampleRate) {
            const pcm16 = new Int16Array(pcmData);
            const buffer = new ArrayBuffer(44 + pcm16.byteLength);
            const view = new DataView(buffer);
            const writeString = (o, s) => { for (let i = 0; i < s.length; i++) view.setUint8(o + i, s.charCodeAt(i)); };
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + pcm16.byteLength, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, pcm16.byteLength, true);
            for (let i = 0; i < pcm16.length; i++) view.setInt16(44 + (i * 2), pcm16[i], true);
            return new Blob([buffer], { type: 'audio/wav' });
        }

        async function speak(text) {
            if (!apiKey) {
                console.error("No hay API Key configurada.");
                document.getElementById('error-msg').classList.remove('hidden');
                return;
            }

            iconPlay.classList.add('hidden');
            spinner.classList.remove('hidden');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Di la palabra: ${text}` }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
                        }
                    })
                });

                const result = await response.json();
                const audioData = result.candidates[0].content.parts[0].inlineData;
                const binary = atob(audioData.data);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                
                const blob = pcmToWav(bytes.buffer, 16000);
                const url = URL.createObjectURL(blob);
                
                if (currentAudio) currentAudio.pause();
                currentAudio = new Audio(url);
                currentAudio.play();
            } catch (err) {
                console.error(err);
                document.getElementById('error-msg').classList.remove('hidden');
            } finally {
                iconPlay.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        }

        function celebrate(e) {
            const colors = ['#10b981', '#34d399', '#059669', '#6ee7b7'];
            for (let i = 0; i < 40; i++) {
                const p = document.createElement('div');
                p.className = 'firecracker';
                p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                const angle = Math.random() * Math.PI * 2;
                const dist = Math.random() * 200 + 50;
                p.style.setProperty('--tw-x', `${Math.cos(angle) * dist}px`);
                p.style.setProperty('--tw-y', `${Math.sin(angle) * dist}px`);
                p.style.left = '50%';
                p.style.top = '50%';
                p.style.animation = `particle 0.8s ease-out forwards`;
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 800);
            }
        }

        function check() {
            const userVal = input.value.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const targetVal = words[index].toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

            if (userVal === targetVal) {
                celebrate();
                btnNext.classList.remove('hidden');
                input.disabled = true;
                index++;
            } else {
                input.classList.add('border-red-500');
                setTimeout(() => input.classList.remove('border-red-500'), 500);
            }
        }

        btnPlay.onclick = () => speak(words[index]);
        btnNext.onclick = () => {
            btnNext.classList.add('hidden');
            input.disabled = false;
            input.value = "";
            countDisplay.innerText = index + 1;
            input.focus();
            speak(words[index]);
        };

        input.onkeydown = (e) => { if (e.key === 'Enter') check(); };

        // Al iniciar, enfocar el input
        window.onload = () => input.focus();

    </script>
</body>
</html>
