<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NWEA: Comparaci√≥n de Rect√°ngulos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap');
        
        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: #f8fafc; 
            color: #1e293b;
            margin: 0;
            padding: 10px;
            -webkit-tap-highlight-color: transparent;
        }

        .nwea-card {
            width: 100%;
            max-width: 950px;
            margin: auto;
            background: white;
            border-radius: 32px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15);
            border: 4px solid #e2e8f0;
            overflow: hidden;
        }

        .measurement-grid {
            display: flex;
            flex-direction: column;
            gap: 40px;
            padding: 40px 20px 40px 60px;
            position: relative;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 44px 44px;
        }

        .start-line {
            position: absolute;
            left: 58px;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #64748b;
            z-index: 20;
        }

        .bar-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 10;
        }

        .color-bar {
            height: 45px;
            border-radius: 0 8px 8px 0;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: rgba(255,255,255,0.8);
            font-weight: 900;
        }

        .unit-ruler {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: rgba(241, 245, 249, 0.8);
            border-radius: 8px;
            width: fit-content;
        }

        .unit-clip {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            background: white;
            border: 2px solid #cbd5e1;
            border-radius: 6px;
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .option-btn {
            border: 3px solid #e2e8f0;
            border-radius: 20px;
            padding: 20px;
            font-size: 1.8rem;
            font-weight: 900;
            background: white;
            transition: all 0.2s;
            cursor: pointer;
        }

        .option-btn:active { transform: scale(0.95); }
        .option-btn.correct { background: #dcfce7; border-color: #22c55e; color: #166534; }
        .option-btn.wrong { background: #fee2e2; border-color: #ef4444; color: #991b1b; }

        .label-tag {
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            font-size: 0.75rem;
        }
    </style>
</head>
<body class="min-h-screen flex items-center">

    <div class="nwea-card">
        <div class="bg-slate-800 p-6 flex justify-between items-center text-white">
            <div class="flex items-center gap-4">
                <div class="bg-yellow-400 p-2 rounded-lg text-slate-900">üìè</div>
                <div>
                    <h1 class="text-xl font-black uppercase tracking-tight">Medici√≥n de Rect√°ngulos</h1>
                    <p class="text-slate-400 text-xs font-bold">Compara el largo y encuentra la diferencia</p>
                </div>
            </div>
            <div class="bg-slate-700 px-6 py-2 rounded-2xl font-black text-xl border-2 border-slate-600" id="progress">1 / 13</div>
        </div>

        <div id="game-area" class="p-6 md:p-8">
            <div class="flex items-center gap-4 mb-8 bg-slate-50 p-6 rounded-3xl border-2 border-slate-100">
                <button id="playAudio" class="bg-indigo-600 hover:bg-indigo-700 text-white p-5 rounded-2xl shadow-lg transition-transform active:scale-90">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                    </svg>
                </button>
                <h2 id="questionText" class="text-2xl font-extrabold text-slate-800">Cargando...</h2>
            </div>

            <div class="grid lg:grid-cols-12 gap-8">
                <div class="lg:col-span-8 bg-white border-4 border-slate-50 rounded-3xl overflow-hidden shadow-inner min-h-[450px]">
                    <div id="chartContainer" class="measurement-grid h-full"></div>
                </div>

                <div class="lg:col-span-4 flex flex-col justify-center gap-4">
                    <p class="text-center font-black text-slate-400 uppercase text-sm mb-2">Selecciona un n√∫mero</p>
                    <div id="optionsGrid" class="grid grid-cols-1 gap-4"></div>
                </div>
            </div>

            <div class="mt-8 text-center">
                <button id="nextBtn" class="hidden bg-emerald-500 text-white px-12 py-5 rounded-2xl font-black text-2xl hover:bg-emerald-600 transition-all shadow-xl hover:-translate-y-1">
                    SIGUIENTE PREGUNTA ‚Üí
                </button>
            </div>
        </div>

        <div id="results" class="hidden p-20 text-center">
            <div class="text-9xl mb-6">üéØ</div>
            <h2 class="text-5xl font-black text-slate-800 mb-2">¬°Completado!</h2>
            <p class="text-slate-500 font-bold mb-8">Has dominado la comparaci√≥n de medidas.</p>
            <div class="text-8xl font-black text-indigo-600 mb-12" id="finalScore">13 / 13</div>
            <button onclick="location.reload()" class="bg-slate-900 text-white px-12 py-5 rounded-2xl font-black text-xl">VOLVER A INTENTAR</button>
        </div>
    </div>

    <script>
        const exercises = [
            { q: "¬øCu√°ntos clips M√ÅS mide el rect√°ngulo amarillo que el rojo?", bars: [{c: "#fbbf24", v: 8, l: "Amarillo"}, {c: "#ef4444", v: 5, l: "Rojo"}], ans: "3", opts: ["2", "3", "4"] },
            { q: "¬øQu√© tanto M√ÅS mide el rect√°ngulo azul que el verde?", bars: [{c: "#3b82f6", v: 9, l: "Azul"}, {c: "#22c55e", v: 4, l: "Verde"}], ans: "5", opts: ["4", "5", "6"] },
            { q: "¬øCu√°ntos clips M√ÅS mide el rect√°ngulo morado que el naranja?", bars: [{c: "#a855f7", v: 7, l: "Morado"}, {c: "#f97316", v: 3, l: "Naranja"}], ans: "4", opts: ["3", "4", "5"] },
            { q: "¬øQu√© tanto M√ÅS mide el rect√°ngulo rosa que el gris?", bars: [{c: "#ec4899", v: 6, l: "Rosa"}, {c: "#64748b", v: 2, l: "Gris"}], ans: "4", opts: ["2", "4", "6"] },
            { q: "¬øCu√°ntos clips M√ÅS mide el rect√°ngulo cian que el caf√©?", bars: [{c: "#06b6d4", v: 10, l: "Cian"}, {c: "#78350f", v: 7, l: "Caf√©"}], ans: "3", opts: ["3", "2", "4"] },
            { q: "¬øQu√© tanto M√ÅS mide el rect√°ngulo verde que el rojo?", bars: [{c: "#16a34a", v: 8, l: "Verde"}, {c: "#dc2626", v: 6, l: "Rojo"}], ans: "2", opts: ["1", "2", "3"] },
            { q: "¬øCu√°ntos clips M√ÅS mide el rect√°ngulo negro que el amarillo?", bars: [{c: "#18181b", v: 9, l: "Negro"}, {c: "#facc15", v: 5, l: "Amarillo"}], ans: "4", opts: ["4", "3", "5"] },
            { q: "¬øQu√© tanto M√ÅS mide el rect√°ngulo naranja que el azul?", bars: [{c: "#ea580c", v: 7, l: "Naranja"}, {c: "#2563eb", v: 4, l: "Azul"}], ans: "3", opts: ["2", "3", "4"] },
            { q: "¬øCu√°ntas unidades M√ÅS mide el rect√°ngulo rojo que el rosa?", bars: [{c: "#b91c1c", v: 5, l: "Rojo"}, {c: "#db2777", v: 2, l: "Rosa"}], ans: "3", opts: ["2", "3", "4"] },
            { q: "¬øQu√© tanto M√ÅS mide el rect√°ngulo violeta que el verde lima?", bars: [{c: "#7c3aed", v: 8, l: "Violeta"}, {c: "#84cc16", v: 3, l: "Lima"}], ans: "5", opts: ["5", "4", "6"] },
            { q: "¬øCu√°ntos clips M√ÅS mide el rect√°ngulo azul que el cian?", bars: [{c: "#1d4ed8", v: 9, l: "Azul"}, {c: "#0891b2", v: 7, l: "Cian"}], ans: "2", opts: ["2", "3", "1"] },
            { q: "¬øQu√© tanto M√ÅS mide el rect√°ngulo rojo que el caf√©?", bars: [{c: "#ef4444", v: 6, l: "Rojo"}, {c: "#451a03", v: 4, l: "Caf√©"}], ans: "2", opts: ["2", "1", "3"] },
            { q: "¬øCu√°ntas unidades M√ÅS mide el rect√°ngulo gris que el negro?", bars: [{c: "#94a3b8", v: 10, l: "Gris"}, {c: "#09090b", v: 3, l: "Negro"}], ans: "7", opts: ["6", "7", "8"] }
        ];

        let currentIdx = 0;
        let score = 0;
        let canAnswer = true;
        let voices = [];

        // L√≥gica optimizada para Safari / iOS
        function setupVoices() {
            voices = window.speechSynthesis.getVoices();
        }

        if (window.speechSynthesis.onvoiceschanged !== undefined) {
            window.speechSynthesis.onvoiceschanged = setupVoices;
        }

        function getBestVoice() {
            setupVoices(); // Re-chequeo por si Safari las carg√≥ despu√©s
            const langPatterns = ['es-ES', 'es-MX', 'es-US', 'es'];
            const namePatterns = ['Sof√≠a', 'Sandra', 'Ni√±a', 'Femenina', 'Female', 'Google espa√±ol'];

            // 1. Buscar voz femenina/infantil en espa√±ol
            for (let lang of langPatterns) {
                const langVoices = voices.filter(v => v.lang.includes(lang));
                for (let name of namePatterns) {
                    const found = langVoices.find(v => v.name.includes(name));
                    if (found) return found;
                }
            }

            // 2. Fallback: Cualquier voz en espa√±ol (preferencia MX)
            return voices.find(v => v.lang === 'es-MX') || voices.find(v => v.lang.startsWith('es')) || null;
        }

        function speak(text) {
            if (!window.speechSynthesis) return;
            
            window.speechSynthesis.cancel();
            
            const ut = new SpeechSynthesisUtterance(text);
            const selectedVoice = getBestVoice();
            
            if (selectedVoice) {
                ut.voice = selectedVoice;
            }

            // Par√°metros estrictos solicitados
            ut.rate = 0.9;
            ut.pitch = 1.2;
            ut.lang = 'es-MX';

            window.speechSynthesis.speak(ut);
        }

        function loadQuestion() {
            const ex = exercises[currentIdx];
            canAnswer = true;
            document.getElementById('progress').innerText = `${currentIdx + 1} / 13`;
            document.getElementById('questionText').innerText = ex.q;
            document.getElementById('nextBtn').classList.add('hidden');
            
            const chart = document.getElementById('chartContainer');
            chart.innerHTML = '<div class="start-line"></div>';

            ex.bars.forEach(bar => {
                const container = document.createElement('div');
                container.className = "bar-container";

                const label = document.createElement('div');
                label.className = "label-tag";
                label.innerText = bar.l;

                const visualBar = document.createElement('div');
                visualBar.className = "color-bar";
                visualBar.style.backgroundColor = bar.c;
                visualBar.style.width = `${bar.v * 44}px`;
                
                const ruler = document.createElement('div');
                ruler.className = "unit-ruler";
                for(let i=0; i<bar.v; i++) {
                    const clip = document.createElement('div');
                    clip.className = "unit-clip";
                    clip.innerText = "üìé";
                    ruler.appendChild(clip);
                }

                container.appendChild(label);
                container.appendChild(visualBar);
                container.appendChild(ruler);
                chart.appendChild(container);
            });

            const grid = document.getElementById('optionsGrid');
            grid.innerHTML = '';
            ex.opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn shadow-lg hover:shadow-xl hover:bg-slate-50 transition-all';
                btn.innerText = opt;
                btn.onclick = () => check(opt, btn);
                grid.appendChild(btn);
            });

            // Auto-locuci√≥n al iniciar (excepto primera vez por interacci√≥n requerida en Safari)
            if (currentIdx > 0) {
                setTimeout(() => speak(ex.q), 300);
            }
        }

        function check(val, btn) {
            if (!canAnswer) return;
            canAnswer = false;
            const correctAns = exercises[currentIdx].ans;
            
            if (val === correctAns) {
                btn.classList.add('correct');
                score++;
                speak("¬°Muy bien hecho!");
            } else {
                btn.classList.add('wrong');
                speak("Esa no es la diferencia. Cuenta cu√°ntos clips extra tiene el rect√°ngulo largo.");
                Array.from(document.getElementsByClassName('option-btn')).forEach(b => {
                    if (b.innerText === correctAns) b.classList.add('correct');
                });
            }
            document.getElementById('nextBtn').classList.remove('hidden');
        }

        document.getElementById('playAudio').onclick = () => speak(exercises[currentIdx].q);
        document.getElementById('nextBtn').onclick = () => {
            currentIdx++;
            if (currentIdx < exercises.length) loadQuestion();
            else {
                document.getElementById('game-area').classList.add('hidden');
                document.getElementById('results').classList.remove('hidden');
                document.getElementById('finalScore').innerText = `${score} / 13`;
            }
        };

        // Inicializaci√≥n tras peque√±o retardo para asegurar carga de voces
        setTimeout(() => {
            setupVoices();
            loadQuestion();
        }, 100);
    </script>
</body>
</html>
