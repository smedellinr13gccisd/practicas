<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pr√°ctica Interactiva de Ecuaciones</title>
    <!-- Tailwind CSS CDN para estilos r√°pidos y responsivos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font 'Inter' -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- Tone.js CDN para efectos de sonido -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            touch-action: manipulation; /* Optimizaci√≥n para iPad (evita zoom accidental) */
        }
        .flag {
            width: 30px;
            height: 40px;
            background-color: #f97316;
            border-radius: 0 0 5px 5px;
            border: 2px solid #a16207;
            position: absolute;
            top: 0;
            right: 0;
            transform: translateY(-100%);
            transition: background-color 0.3s ease;
        }
        .flag-green { background-color: #10b981; border-color: #059669; }
        .flag-red { background-color: #ef4444; border-color: #dc2626; }

        .equation-box {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            min-width: 50px;
            height: 50px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 1.5rem;
            font-weight: 600;
            background-color: #ffffff;
            position: relative;
        }
        .input-box {
            background-color: #fef3c7;
            border: 2px dashed #f59e0b;
        }
        .step-container {
            display: none;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .invisible-align {
            visibility: hidden;
            pointer-events: none;
            flex: 1;
            display: flex;
            justify-content: flex-end;
        }
        .complex-side-highlight {
            position: relative;
            padding: 0 4px;
        }
        .complex-side-highlight::before {
            content: '';
            position: absolute;
            top: -5px; right: -5px; bottom: -5px; left: -5px;
            border: 2px dashed #f59e0b;
            border-radius: 8px;
            pointer-events: none;
        }
    </style>
</head>
<body class="p-4 flex items-start justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-xl bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-gray-100">

        <h1 class="text-3xl font-extrabold text-blue-800 mb-4 text-center">
            Balanceo de Ecuaciones (1er Grado)
        </h1>
        
        <!-- Contador de Estad√≠sticas - Mejorado para iPads -->
        <div class="flex justify-around text-sm font-semibold mb-6 p-3 bg-gray-100 rounded-lg">
            <p class="text-green-600">Resueltos: <span id="solved-counter" class="text-lg font-bold">0</span></p>
            <p class="text-red-600">Errores: <span id="error-counter" class="text-lg font-bold">0</span></p>
        </div>

        <p class="text-gray-600 mb-8 text-center">
            Instrucci√≥n: Sigue los pasos para encontrar el valor de $N$.
        </p>

        <div class="flex justify-center items-center text-2xl font-bold mb-8 space-x-2">
            <span class="text-gray-500">Ecuaci√≥n:</span>
            <span id="full-equation-display" class="text-blue-600"></span>
        </div>

        <!-- PASO 1 -->
        <div id="phase-1-container" class="step-container" style="display: block; border-top: none; margin-top: 0;">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Paso 1: Identifica el lado a simplificar primero.</h2>
            <div class="relative p-6 border-2 border-gray-300 rounded-lg bg-gray-50 flex flex-col items-center space-y-6">
                <div class="flag" id="flag-1"></div>
                <div class="flex items-center text-3xl font-extrabold space-x-3">
                    <div id="p1-left-container" class="p-2 border-2 rounded-lg border-green-400 bg-green-50/50">
                        <span id="display-left-side" class="text-green-600 font-bold"></span>
                    </div>
                    <span class="text-gray-800">=</span>
                    <div id="p1-right-container" class="p-2 border-2 rounded-lg border-blue-400 bg-blue-50/50">
                        <span id="display-right-side" class="text-blue-600 font-bold"></span>
                    </div>
                </div>
                <div class="flex space-x-4 w-full justify-center mt-4">
                    <button id="select-left-btn" class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg shadow-md transition transform hover:scale-105">
                        Lado Izquierdo
                    </button>
                    <button id="select-right-btn" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-lg shadow-md transition transform hover:scale-105">
                        Lado Derecho
                    </button>
                </div>
            </div>
            <p id="feedback-1" class="text-center mt-4 text-sm font-medium h-6"></p>
        </div>

        <!-- PASO 2 -->
        <div id="phase-2-container" class="step-container">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Paso 2: Simplifica el lado de las constantes.</h2>
            <div class="relative p-6 border-2 border-gray-300 rounded-lg bg-gray-50 flex flex-col items-center space-y-4">
                <div class="flag" id="flag-2"></div>
                <div class="flex items-center text-3xl font-extrabold space-x-3 mb-4 w-full justify-center">
                    <div id="p2-left-display"></div>
                    <span class="text-gray-800">=</span>
                    <div id="p2-right-display"></div>
                </div>
                <div id="alignment-wrapper" class="w-full flex justify-center items-end"></div>
                <div class="w-full flex justify-center pt-8"> 
                    <button id="check-phase-2-btn" class="px-6 py-3 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg shadow-md transition transform hover:scale-105">
                        Verificar Simplificaci√≥n
                    </button>
                </div>
            </div>
            <p id="feedback-2" class="text-center mt-4 text-sm font-medium h-6"></p>
        </div>

        <!-- PASO 3 y 4 -->
        <div id="phase-3-container" class="step-container">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Paso 3: Ecuaci√≥n simplificada.</h2>
            <div class="p-6 border-2 border-gray-300 rounded-lg bg-gray-100 flex flex-col items-center space-y-4 mb-6">
                <div class="flex items-center text-3xl font-extrabold space-x-3" id="p3-simplified-display"></div>
            </div>
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Paso 4: Balancea la ecuaci√≥n y encuentra $N$.</h2>
            <div class="relative p-6 border-2 border-gray-300 rounded-lg bg-gray-50 flex flex-col items-center space-y-4">
                <div class="flag" id="flag-3"></div>
                <div class="flex items-center text-3xl font-extrabold space-x-3 mb-4" id="p4-final-balance-display"></div>
                <div class="w-full flex justify-center">
                    <button id="check-phase-3-btn" class="px-6 py-3 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg shadow-md transition transform hover:scale-105">
                        Verificar N
                    </button>
                </div>
            </div>
            <p id="feedback-3" class="text-center mt-4 text-sm font-medium h-6"></p>
        </div>

        <!-- RESULTADO FINAL -->
        <div id="phase-4-container" class="step-container text-center pt-8 pb-4">
            <div class="text-5xl mb-4">üèÜ</div>
            <h2 class="text-3xl font-bold text-green-600 mb-2">¬°Pr√°ctica Terminada!</h2>
            <p class="text-xl font-bold mt-4">N = <span id="final-answer-display"></span></p>
            <button id="reset-btn" class="mt-8 px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg">
                Siguiente Problema
            </button>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACI√ìN FIREBASE ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let db, auth, userId = null;

        // --- ESTADO LOCAL DEL CONTADOR (Inmediato para iPad) ---
        let localStats = { solvedCount: 0, errorCount: 0 };

        function updateDisplay() {
            document.getElementById('solved-counter').textContent = localStats.solvedCount;
            document.getElementById('error-counter').textContent = localStats.errorCount;
        }

        // --- INICIALIZACI√ìN DE FIREBASE ---
        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    syncWithCloud();
                } else {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                }
            });
        }

        async function syncWithCloud() {
            if (!db || !userId) return;
            const statsRef = doc(db, 'artifacts', appId, 'users', userId, 'stats', 'main');
            
            // Escuchar cambios de la nube pero priorizar lo que el ni√±o est√° haciendo ahora
            onSnapshot(statsRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Solo actualizamos localmente si los datos de la nube son mayores (para no perder progreso)
                    if (data.solvedCount > localStats.solvedCount) localStats.solvedCount = data.solvedCount;
                    if (data.errorCount > localStats.errorCount) localStats.errorCount = data.errorCount;
                    updateDisplay();
                }
            }, (error) => console.error("Cloud sync error:", error));
        }

        async function saveStats() {
            updateDisplay(); // Actualiza la pantalla de inmediato
            if (!db || !userId) return;
            const statsRef = doc(db, 'artifacts', appId, 'users', userId, 'stats', 'main');
            try {
                await setDoc(statsRef, localStats, { merge: true });
            } catch (e) { console.error("Error saving stats:", e); }
        }

        // --- L√ìGICA DEL JUEGO ---
        document.addEventListener('DOMContentLoaded', () => {
            const state = { currentPhase: 1, equation: {} };
            const synth = new Tone.Synth().toDestination();

            function playSound(isCorrect) {
                if (Tone.context.state !== 'running') Tone.start();
                if (isCorrect) {
                    synth.triggerAttackRelease('C5', '8n', Tone.now());
                    synth.triggerAttackRelease('E5', '8n', Tone.now() + 0.1);
                } else {
                    synth.triggerAttackRelease('G2', '4n');
                }
            }

            function updateFlag(phase, isCorrect, message) {
                const flagEl = document.getElementById(`flag-${phase}`);
                const feedbackEl = document.getElementById(`feedback-${phase}`);
                if (isCorrect) {
                    flagEl.className = 'flag flag-green';
                    feedbackEl.textContent = '¬°Muy bien! ' + message;
                    feedbackEl.className = 'text-center mt-4 text-sm font-medium h-6 text-green-600';
                } else {
                    flagEl.className = 'flag flag-red';
                    feedbackEl.textContent = '¬°Oh oh! ' + message;
                    feedbackEl.className = 'text-center mt-4 text-sm font-medium h-6 text-red-500';
                    localStats.errorCount++;
                    saveStats();
                }
                playSound(isCorrect);
            }

            function generateEquation() {
                // N√∫meros peque√±os para "Count On" (m√°ximo 10-13)
                const N = Math.floor(Math.random() * 3) + 3; // 3-5
                const C_Var = Math.floor(Math.random() * 3) + 3; // 3-5
                const R = N + C_Var; // R entre 6 y 10

                let C_A, C_B, OP;
                if (Math.random() < 0.5) {
                    OP = '+';
                    C_A = Math.floor(Math.random() * (R - 2)) + 1;
                    C_B = R - C_A;
                } else {
                    OP = '-';
                    C_B = Math.floor(Math.random() * 3) + 1;
                    C_A = R + C_B; // Max 10+3=13
                }

                const simplifySide = Math.random() < 0.5 ? 'right' : 'left';
                const complex = `${C_A} ${OP} ${C_B}`;
                const simple = `N + ${C_Var}`;

                return {
                    N, C_Var, C_A, C_B, R, OP, simplifySide,
                    leftSide: simplifySide === 'left' ? complex : simple,
                    rightSide: simplifySide === 'right' ? complex : simple,
                    full: simplifySide === 'left' ? `${complex} = ${simple}` : `${simple} = ${complex}`
                };
            }

            function showPhase(p) {
                for (let i = 1; i <= 4; i++) {
                    const el = document.getElementById(`phase-${i}-container`);
                    if (el) el.style.display = i <= p ? 'block' : 'none';
                }
                if (p > 1) {
                    document.getElementById(`phase-${p}-container`).scrollIntoView({ behavior: 'smooth' });
                }
            }

            function startNew() {
                state.equation = generateEquation();
                state.currentPhase = 1;
                
                // Reset UI
                document.getElementById('full-equation-display').textContent = state.equation.full;
                document.getElementById('display-left-side').textContent = state.equation.leftSide;
                document.getElementById('display-right-side').textContent = state.equation.rightSide;
                
                // Colorizaci√≥n de bloques
                const lBox = document.getElementById('p1-left-container');
                const rBox = document.getElementById('p1-right-container');
                if(state.equation.simplifySide === 'left') {
                    lBox.className = 'p-2 border-2 rounded-lg border-blue-400 bg-blue-50';
                    rBox.className = 'p-2 border-2 rounded-lg border-green-400 bg-green-50';
                } else {
                    lBox.className = 'p-2 border-2 rounded-lg border-green-400 bg-green-50';
                    rBox.className = 'p-2 border-2 rounded-lg border-blue-400 bg-blue-50';
                }

                document.querySelectorAll('.flag').forEach(f => f.className = 'flag');
                document.querySelectorAll('[id^="feedback-"]').forEach(f => f.textContent = '');
                document.querySelectorAll('input').forEach(i => { i.value = ''; i.disabled = false; });
                document.querySelectorAll('button').forEach(b => b.disabled = false);

                showPhase(1);
            }

            // --- EVENTOS ---
            document.getElementById('select-left-btn').onclick = () => handleP1('left');
            document.getElementById('select-right-btn').onclick = () => handleP1('right');

            function handleP1(side) {
                if (side === state.equation.simplifySide) {
                    updateFlag(1, true, "¬°Ese es el lado correcto!");
                    document.getElementById('select-left-btn').disabled = true;
                    document.getElementById('select-right-btn').disabled = true;
                    
                    // Preparar Paso 2
                    const complexHTML = `<div class="complex-side-highlight text-blue-600">${state.equation.C_A} ${state.equation.OP} ${state.equation.C_B}</div>`;
                    const simpleHTML = `<div class="text-green-600">N + ${state.equation.C_Var}</div>`;
                    
                    document.getElementById('p2-left-display').innerHTML = state.equation.simplifySide === 'left' ? complexHTML : simpleHTML;
                    document.getElementById('p2-right-display').innerHTML = state.equation.simplifySide === 'right' ? complexHTML : simpleHTML;
                    
                    const inputHTML = `<input type="number" id="input-p2" class="equation-box input-box w-32 mt-4" placeholder="?">`;
                    const wrapper = document.getElementById('alignment-wrapper');
                    if(state.equation.simplifySide === 'left') {
                        wrapper.innerHTML = `<div class="w-1/2 flex justify-center">${inputHTML}</div><div class="invisible-align w-1/2">= N + 0</div>`;
                    } else {
                        wrapper.innerHTML = `<div class="invisible-align w-1/2">N + 0 =</div><div class="w-1/2 flex justify-center">${inputHTML}</div>`;
                    }
                    
                    setTimeout(() => showPhase(2), 800);
                } else {
                    updateFlag(1, false, "Ese lado tiene la N, busca el otro.");
                }
            }

            document.getElementById('check-phase-2-btn').onclick = () => {
                const val = parseInt(document.getElementById('input-p2').value);
                if (val === state.equation.R) {
                    updateFlag(2, true, `¬°S√≠! Es ${state.equation.R}.`);
                    document.getElementById('input-p2').disabled = true;
                    document.getElementById('check-phase-2-btn').disabled = true;

                    // Preparar Paso 3 y 4
                    const R = state.equation.R;
                    const CV = state.equation.C_Var;
                    const simL = state.equation.simplifySide === 'left' ? R : `N + ${CV}`;
                    const simR = state.equation.simplifySide === 'right' ? R : `N + ${CV}`;
                    document.getElementById('p3-simplified-display').innerHTML = `<span>${simL}</span> <span>=</span> <span>${simR}</span>`;

                    const inputN = `<input type="number" id="input-p3" class="equation-box input-box w-20" placeholder="N">`;
                    const varSide = `<div class="flex items-center space-x-2">${inputN} <span>+</span> <span>${CV}</span></div>`;
                    const constSide = `<span class="text-blue-600">${R}</span>`;
                    
                    document.getElementById('p4-final-balance-display').innerHTML = 
                        state.equation.simplifySide === 'right' ? `${varSide} = ${constSide}` : `${constSide} = ${varSide}`;

                    setTimeout(() => showPhase(3), 800);
                } else {
                    updateFlag(2, false, "Cuenta con tus dedos otra vez.");
                }
            };

            document.getElementById('check-phase-3-btn').onclick = () => {
                const val = parseInt(document.getElementById('input-p3').value);
                if (val === state.equation.N) {
                    updateFlag(3, true, "¬°Lo lograste!");
                    document.getElementById('input-p3').disabled = true;
                    document.getElementById('check-phase-3-btn').disabled = true;
                    document.getElementById('final-answer-display').textContent = state.equation.N;
                    
                    localStats.solvedCount++;
                    saveStats();
                    
                    setTimeout(() => showPhase(4), 800);
                } else {
                    updateFlag(3, false, `¬øQu√© n√∫mero m√°s ${state.equation.C_Var} da ${state.equation.R}?`);
                }
            };

            document.getElementById('reset-btn').onclick = startNew;

            startNew();
        });
    </script>
</body>
</html>
