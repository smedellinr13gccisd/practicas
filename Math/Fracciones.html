<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fracciones Visuales - 22 Retos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap');
        
        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: #f0f9ff; 
            margin: 0;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        .math-card {
            width: 100%;
            max-width: 650px;
            background: white;
            border-radius: 32px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            border: 4px solid #bae6fd;
            overflow: hidden;
        }

        .fraction-display {
            background: #ffffff;
            border-radius: 24px;
            padding: 30px;
            min-height: 280px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 20px;
            border: 2px solid #e0f2fe;
        }

        .num-btn {
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 20px;
            padding: 12px;
            font-size: 1.5rem;
            font-weight: 900;
            transition: all 0.2s;
            cursor: pointer;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .fraction-line {
            width: 30px;
            height: 3px;
            background: currentColor;
            margin: 2px 0;
        }

        .num-btn:active { transform: scale(0.95); }
        .num-btn.correct { background: #dcfce7; border-color: #22c55e; color: #166534; }
        .num-btn.wrong { background: #fee2e2; border-color: #ef4444; color: #991b1b; }

        .stat-badge {
            background: rgba(0,0,0,0.1);
            padding: 6px 16px;
            border-radius: 12px;
            font-weight: 800;
            color: #1e293b;
        }

        svg {
            transform: rotate(-90deg);
            border-radius: 50%;
            background: #e2e8f0;
        }

        #playInstruction {
            transition: transform 0.1s;
        }
        #playInstruction:active { transform: scale(0.9); }
    </style>
</head>
<body>

    <div class="math-card">
        <div class="bg-sky-700 p-5 flex justify-between items-center text-white">
            <div class="flex items-center gap-2">
                <span class="text-2xl">üç∞</span>
                <h1 class="text-xl font-black uppercase">Fracciones</h1>
            </div>
            <div class="flex gap-3 text-white">
                <div class="stat-badge text-white bg-sky-800" id="progress">1 / 22</div>
                <div class="stat-badge text-yellow-300 bg-sky-800">‚≠ê <span id="score" class="text-white">0</span></div>
            </div>
        </div>

        <div id="game-container">
            <div class="p-6 text-center">
                <button id="playInstruction" class="mb-4 bg-sky-500 text-white p-4 rounded-full shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                    </svg>
                </button>
                <h2 class="text-xl font-bold text-slate-700 mb-6">¬øQu√© fracci√≥n est√° coloreada?</h2>
                <div class="fraction-display" id="fractionArea"></div>
            </div>

            <div id="options" class="grid grid-cols-2 gap-4 px-6 pb-6"></div>

            <div class="px-6 pb-8 text-center">
                <button id="nextBtn" class="hidden w-full bg-sky-900 text-white py-5 rounded-2xl font-black text-xl shadow-xl hover:bg-black transition-colors">
                    SIGUIENTE ‚ûî
                </button>
            </div>
        </div>

        <div id="finish-screen" class="hidden p-12 text-center">
            <div class="text-7xl mb-4">üèÜ</div>
            <h2 class="text-4xl font-black text-slate-800 mb-2">¬°Incre√≠ble!</h2>
            <div class="text-6xl font-black text-slate-900 mb-8" id="finalScore">0 / 22</div>
            <button onclick="location.reload()" class="bg-sky-900 text-white px-10 py-4 rounded-2xl font-bold hover:bg-black transition-transform active:scale-95">REINTENTAR</button>
        </div>
    </div>

    <script>
        let currentIdx = 0;
        let score = 0;
        let canAnswer = true;
        let correctNum = 0;
        let correctDen = 0;
        const totalQuestions = 22;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // Configuraci√≥n de Voces
        let voices = [];
        function initVoices() {
            voices = window.speechSynthesis.getVoices();
        }
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = initVoices;
        }

        function getBestVoice() {
            const allVoices = window.speechSynthesis.getVoices();
            // Prioridad: Voces femeninas/infantiles conocidas en espa√±ol
            const priorityNames = ['Sof√≠a', 'Sandra', 'Paulina', 'M√≥nica', 'Ni√±a', 'Femenina', 'Female', 'Google espa√±ol'];
            
            let bestVoice = allVoices.find(v => 
                v.lang.startsWith('es') && 
                priorityNames.some(name => v.name.includes(name))
            );

            // Fallback a cualquier voz en espa√±ol (preferencia MX)
            if (!bestVoice) {
                bestVoice = allVoices.find(v => v.lang === 'es-MX') || allVoices.find(v => v.lang.startsWith('es'));
            }

            return bestVoice;
        }

        function speak(text) {
            window.speechSynthesis.cancel(); // Detener cualquier audio previo
            const utterance = new SpeechSynthesisUtterance(text);
            const voice = getBestVoice();
            
            if (voice) utterance.voice = voice;
            
            utterance.lang = 'es-MX';
            utterance.rate = 0.9;  // Velocidad optimizada
            utterance.pitch = 1.2; // Tono m√°s agudo/infantil
            
            window.speechSynthesis.speak(utterance);
        }

        function playSound(type) {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'success') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            } else {
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
                oscillator.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.2);
                gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
            }
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.3);
        }

        function generateProblem() {
            canAnswer = true;
            document.getElementById('nextBtn').classList.add('hidden');
            document.getElementById('progress').innerText = `${currentIdx + 1} / ${totalQuestions}`;

            correctDen = Math.floor(Math.random() * 7) + 2; 
            correctNum = Math.floor(Math.random() * correctDen) + 1;

            const area = document.getElementById('fractionArea');
            area.innerHTML = '';

            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", "200");
            svg.setAttribute("height", "200");
            svg.setAttribute("viewBox", "0 0 100 100");

            const radius = 50, cx = 50, cy = 50;

            for (let i = 0; i < correctDen; i++) {
                const startAngle = (i * 360) / correctDen;
                const endAngle = ((i + 1) * 360) / correctDen;
                const isColoured = i < correctNum;
                
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                const x1 = cx + radius * Math.cos((startAngle * Math.PI) / 180);
                const y1 = cy + radius * Math.sin((startAngle * Math.PI) / 180);
                const x2 = cx + radius * Math.cos((endAngle * Math.PI) / 180);
                const y2 = cy + radius * Math.sin((endAngle * Math.PI) / 180);

                const d = `M ${cx} ${cy} L ${x1} ${y1} A ${radius} ${radius} 0 0 1 ${x2} ${y2} Z`;
                path.setAttribute("d", d);
                path.setAttribute("fill", isColoured ? "#0ea5e9" : "#f1f5f9");
                path.setAttribute("stroke", "#0c4a6e");
                path.setAttribute("stroke-width", "1");
                svg.appendChild(path);
            }
            area.appendChild(svg);

            let options = [{n: correctNum, d: correctDen}];
            while (options.length < 4) {
                let fN = Math.floor(Math.random() * 8) + 1;
                let fD = Math.floor(Math.random() * 7) + 2;
                if (fN > fD) fN = fD;
                if (!options.some(o => o.n === fN && o.d === fD)) options.push({n: fN, d: fD});
            }
            options.sort(() => 0.5 - Math.random());

            const optsDiv = document.getElementById('options');
            optsDiv.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('div');
                btn.className = 'num-btn';
                btn.innerHTML = `<span>${opt.n}</span><div class="fraction-line"></div><span>${opt.d}</span>`;
                btn.onclick = () => checkAnswer(opt, btn);
                optsDiv.appendChild(btn);
            });
        }

        function checkAnswer(val, btn) {
            if (!canAnswer) return;
            canAnswer = false;

            const isCorrect = (val.n === correctNum && val.d === correctDen);

            if (isCorrect) {
                btn.classList.add('correct');
                score++;
                document.getElementById('score').innerText = score;
                playSound('success');
                speak(`¬°Correcto! Son ${correctNum} de ${correctDen}`);
            } else {
                btn.classList.add('wrong');
                playSound('error');
                speak(`No, esa es ${val.n} de ${val.d}. La respuesta correcta es ${correctNum} de ${correctDen}`);
                Array.from(document.getElementsByClassName('num-btn')).forEach(b => {
                    const textContent = b.innerText.replace(/\s/g, '');
                    if (textContent === `${correctNum}${correctDen}`) b.classList.add('correct');
                });
            }
            document.getElementById('nextBtn').classList.remove('hidden');
        }

        document.getElementById('playInstruction').onclick = () => speak("¬øQu√© fracci√≥n est√° coloreada?");
        
        document.getElementById('nextBtn').onclick = () => {
            currentIdx++;
            if (currentIdx < totalQuestions) {
                generateProblem();
            } else {
                document.getElementById('game-container').classList.add('hidden');
                document.getElementById('finish-screen').classList.remove('hidden');
                document.getElementById('finalScore').innerText = `${score} / ${totalQuestions}`;
            }
        };

        // Inicializar voces al cargar
        initVoices();
        window.onload = generateProblem;
    </script>
</body>
</html>
