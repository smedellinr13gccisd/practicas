<script>
        // --- 1. CONFIGURACIÓN DEL JUEGO (6 palabras temáticas para 1er grado) ---
        const palabras = {
            propios: ["Juan", "María", "Sol", "Luna", "Chile", "Abril"],
            comunes: ["Gato", "Casa", "Flor", "Mano", "Comida", "Zapatos"],
            noSustantivos: ["Saltar", "Feliz", "Beber", "Alto", "Canta", "Lento"]
        };
        
        let elementoArrastrado = null; // Elemento actualmente arrastrado (global)

        // --- 2. FUNCIÓN PARA MANEJAR SONIDOS (Web Audio API) ---
        function reproducirSonido(tipo) {
            // Se mantiene la función de sonidos ya que funciona bien.
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return; 

            const audioCtx = new AudioContext();
            const oscilador = audioCtx.createOscillator();
            const ganancia = audioCtx.createGain();

            oscilador.connect(ganancia);
            ganancia.connect(audioCtx.destination);

            if (tipo === 'error') {
                oscilador.frequency.value = 120;
                oscilador.type = 'sawtooth';
                ganancia.gain.setValueAtTime(0.5, audioCtx.currentTime);
                oscilador.start();
                setTimeout(() => {
                    oscilador.stop();
                }, 300); 
            } else if (tipo === 'exito') {
                const now = audioCtx.currentTime;
                oscilador.frequency.setValueAtTime(440, now);
                ganancia.gain.setValueAtTime(0.3, now);
                
                oscilador.start(now);
                oscilador.stop(now + 0.15);
                
                const oscilador2 = audioCtx.createOscillator();
                oscilador2.connect(audioCtx.destination);
                oscilador2.frequency.value = 880; 
                oscilador2.start(now + 0.15);
                oscilador2.stop(now + 0.3);
            }
        }

        // --- 3. FUNCIONES DE ARRASTRE Y SOLTADO PARA RATÓN (Se mantienen como respaldo) ---

        function drag(ev) {
            elementoArrastrado = ev.target;
            ev.dataTransfer.setData("text", ev.target.id);
            // Efecto de arrastre visible
            ev.target.style.backgroundColor = '#ff6961'; 
            ev.target.style.transform = 'scale(1.1)'; 
            ev.target.style.opacity = '0.7'; 
        }

        function dragEnd(ev) {
            if (!ev.target.parentElement.classList.contains('caja-destino')) {
                ev.target.style.backgroundColor = '#f7f7f7'; 
            }
            ev.target.style.transform = 'scale(1.0)';
            ev.target.style.opacity = '1.0';
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }
        
        // --- FUNCIÓN CENTRAL DE SOLTADO (Se usa para ratón y toque) ---
        function manejarDrop(draggedElement, destinoCaja) {
            const destinoTipo = destinoCaja.getAttribute('data-tipo');
            const palabraTipo = draggedElement.getAttribute('data-tipo');
            
            if (palabraTipo === destinoTipo) {
                // Soltar Correcto
                destinoCaja.appendChild(draggedElement);
                draggedElement.style.backgroundColor = '#a8e6cf'; // Verde suave (Éxito)
                draggedElement.style.color = '#0e4a1a'; 
                reproducirSonido('exito'); 
            } else {
                // Soltar Incorrecto
                draggedElement.style.backgroundColor = '#f8d7da'; // Rojo claro (Error)
                reproducirSonido('error'); 
                
                // Restaurar el color base después de medio segundo
                setTimeout(() => {
                    if (!draggedElement.parentElement.classList.contains('caja-destino')) {
                        draggedElement.style.backgroundColor = '#f7f7f7'; 
                        draggedElement.style.color = '#333';
                    }
                }, 500);
            }
            
            // Restaurar estilos visuales finales
            draggedElement.style.transform = 'scale(1.0)';
            draggedElement.style.opacity = '1.0';
            draggedElement.style.position = 'static'; // Volver a la posición normal
            draggedElement.style.left = '0';
            draggedElement.style.top = '0';
        }

        function drop(ev) {
            ev.preventDefault();
            const data = ev.dataTransfer.getData("text");
            const draggedElement = document.getElementById(data);
            
            const destinoCaja = ev.target.classList.contains('caja-destino') ? ev.target : ev.target.closest('.caja-destino');
            
            if (!destinoCaja || !draggedElement) return;

            manejarDrop(draggedElement, destinoCaja);
        }

        // --- 4. FUNCIONES TÁCTILES PARA IPAD (NUEVAS Y CRUCIALES) ---
        
        function touchstart(ev) {
            const touch = ev.touches[0];
            const target = ev.target;

            if (!target.classList.contains('palabra-draggable')) return;
            
            ev.preventDefault();
            elementoArrastrado = target;
            
            // Iniciar efecto visual de arrastre
            elementoArrastrado.style.position = 'absolute';
            elementoArrastrado.style.zIndex = '1000';
            elementoArrastrado.style.backgroundColor = '#ff6961'; 
            elementoArrastrado.style.transform = 'scale(1.1)'; 
            elementoArrastrado.style.opacity = '0.8';

            // Mover el elemento a la posición del toque
            elementoArrastrado.style.left = touch.pageX - elementoArrastrado.offsetWidth / 2 + 'px';
            elementoArrastrado.style.top = touch.pageY - elementoArrastrado.offsetHeight / 2 + 'px';
        }

        function touchmove(ev) {
            if (!elementoArrastrado) return;
            ev.preventDefault();
            const touch = ev.touches[0];
            
            // Mover el elemento siguiendo el dedo
            elementoArrastrado.style.left = touch.pageX - elementoArrastrado.offsetWidth / 2 + 'px';
            elementoArrastrado.style.top = touch.pageY - elementoArrastrado.offsetHeight / 2 + 'px';
        }

        function touchend(ev) {
            if (!elementoArrastrado) return;
            ev.preventDefault();

            // Determinar dónde se "soltó" la palabra
            const touch = ev.changedTouches[0];
            const destino = document.elementFromPoint(touch.clientX, touch.clientY);
            
            let destinoCaja = destino;
            // Buscar si el destino es una caja destino o un elemento dentro de una caja destino
            while (destinoCaja && !destinoCaja.classList.contains('caja-destino')) {
                destinoCaja = destinoCaja.parentElement;
            }

            if (destinoCaja && destinoCaja.classList.contains('caja-destino')) {
                // Soltado en una caja válida
                manejarDrop(elementoArrastrado, destinoCaja);
            } else {
                // Soltado fuera de una caja
                reproducirSonido('error');
                
                // Restaurar estilos al contenedor inicial
                elementoArrastrado.style.backgroundColor = '#f8d7da'; // Muestra el error
                setTimeout(() => {
                    elementoArrastrado.style.backgroundColor = '#f7f7f7'; 
                    elementoArrastrado.style.color = '#333';
                    elementoArrastrado.style.position = 'static';
                    elementoArrastrado.style.transform = 'scale(1.0)';
                    elementoArrastrado.style.opacity = '1.0';
                }, 500);
            }

            elementoArrastrado = null; // Limpiar la variable global
        }
        
        // --- 5. FUNCIÓN PARA ENLAZAR EVENTOS TÁCTILES A LAS PALABRAS ---
        function prepararEventosTactiles() {
            const palabrasDraggable = document.querySelectorAll('.palabra-draggable');
            palabrasDraggable.forEach(palabra => {
                // Asegura que los eventos se añadan solo una vez
                palabra.addEventListener('touchstart', touchstart, false);
                palabra.addEventListener('touchmove', touchmove, false);
                palabra.addEventListener('touchend', touchend, false);
            });
        }

        // --- 6. FUNCIÓN PARA INICIAR EL JUEGO (Creación dinámica de palabras) ---
        function iniciarJuego() {
            const contenedorPalabras = document.getElementById('contenedor-palabras');
            let todasLasPalabras = [];
            
            for (const tipo in palabras) {
                palabras[tipo].forEach(palabra => {
                    todasLasPalabras.push({ texto: palabra, tipo: tipo });
                });
            }
            
            todasLasPalabras.sort(() => Math.random() - 0.5);
            
            todasLasPalabras.forEach((palabra, index) => {
                const p = document.createElement('p');
                p.textContent = palabra.texto;
                p.id = `palabra-${index}`;
                p.className = 'palabra-draggable';
                p.draggable = true;
                p.setAttribute('data-tipo', palabra.tipo);
                // Eventos de ratón
                p.setAttribute('ondragstart', 'drag(event)');
                p.setAttribute('ondragend', 'dragEnd(event)');
                contenedorPalabras.appendChild(p);
            });
            
            // ¡Llamada crucial para que el arrastre táctil funcione!
            prepararEventosTactiles();
        }

        // Llamar a la función al cargar la página
        window.onload = iniciarJuego;
    </script>